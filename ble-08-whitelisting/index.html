<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Tony Fu" /><link rel="canonical" href="https://tonyfu97.github.io/NrfConnectNotes/ble-08-whitelisting/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>BLE-Whitelisting - nRF Connect SDK Notes</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "BLE-Whitelisting";
        var mkdocs_page_input_path = "ble-08-whitelisting.md";
        var mkdocs_page_url = "/NrfConnectNotes/ble-08-whitelisting/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/django.min.js"></script>
      <script>hljs.highlightAll();</script> 
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-274394082"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', "G-274394082");
      </script>
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> nRF Connect SDK Notes
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../setup-01-vscode/">Setup-VSCode</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ble-01-minimal-skeleton/">BLE-Minimal Skeleton</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ble-02-advertising-simple/">BLE-Advertising Simple</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ble-03-advert-connectable/">BLE-Advertising Connectable</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ble-04-conn-params/">BLE-Connection Parameters</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ble-05-gatt-client/">BLE-GATT Client Operations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ble-06-gatt-server/">BLE-GATT Server Operations</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../ble-07-security-modes/">BLE-Security Modes</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">BLE-Whitelisting</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#bonding-with-persistent-storage">Bonding with Persistent Storage</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#whitelisting-aka-filter-accept-list">Whitelisting (a.k.a. Filter Accept List)</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#advertising-with-whitelisting">Advertising with Whitelisting</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#adding-devices-to-the-whitelist">Adding Devices to the Whitelist</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#erasing-bonding-information">Erasing Bonding Information</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../nfc-01-simple-text/">NFC-Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../nfc-02-writable-tag/">NFC-Writable Tag</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../sdk-01-uart/">SDK-UART</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../os-01-basic/">OS-Basic</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../os-02-workqueue/">OS-Workqueue</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../os-03-semaphore-mutex/">OS-Semaphore & Mutex</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">nRF Connect SDK Notes</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">BLE-Whitelisting</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/tonyfu97/NrfConnectNotes/blob/master/docs/ble-08-whitelisting.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="08-ble-whitelisting">08 - BLE Whitelisting</h1>
<p><strong>Author:</strong> Tony Fu<br />
<strong>Date:</strong> 2025/04/26 <br />
<strong>Device:</strong> nRF52840 DK<br />
<strong>Toolchain:</strong> nRF Connect SDK v3.0.0  </p>
<hr />
<p>Note that I have switched from using the nRF52840 Dongle to the nRF52840 DK for this project. This change is because <code>CONFIG_SETTINGS</code> is incompatible with the Dongle. The issue appears to be that the default storage location for the settings subsystem overlaps with the pre-programmed bootloader on the Dongle. The bootloader occupies the range <code>0xE0000</code> to <code>0x100000</code> (1 MB), while the default application build writes settings data starting at <code>0xFE000</code>, which falls within the bootloader region. This leads to flash corruption and a non-functional device (the COM port disappears, and the boot fails). Here is a <a href="https://github.com/zephyrproject-rtos/zephyr/issues/83037">post on the Zephyr forum</a> that explains the issue in more detail.</p>
<hr />
<h2 id="bonding-with-persistent-storage">Bonding with Persistent Storage</h2>
<p>To store Bluetooth bond information across device resets (power cycles), we must enable several configuration options in <code>prj.conf</code>:</p>
<pre><code class="language-kconfig">CONFIG_BT_SETTINGS=y
CONFIG_FLASH=y
CONFIG_FLASH_PAGE_LAYOUT=y
CONFIG_FLASH_MAP=y
CONFIG_NVS=y
CONFIG_SETTINGS_NVS=y
CONFIG_SETTINGS=y
</code></pre>
<table>
<thead>
<tr>
<th style="text-align: left;">Setting</th>
<th style="text-align: left;">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>CONFIG_BT_SETTINGS</strong></td>
<td style="text-align: left;">Allows the Bluetooth stack to save and restore bonding and identity information (like keys) using the settings subsystem. Without this, bonds are lost on reset.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CONFIG_FLASH</strong></td>
<td style="text-align: left;">Provides low-level flash driver support needed to write/read from non-volatile memory.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CONFIG_FLASH_PAGE_LAYOUT</strong></td>
<td style="text-align: left;">Abstracts how flash memory is divided into pages, allowing the system to know how to manage writes and erasures correctly. Important for portable flash handling.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CONFIG_FLASH_MAP</strong></td>
<td style="text-align: left;">Provides logical partitioning of the flash. Required to map certain parts of flash for NVS (and others like MCUBoot, if used).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CONFIG_NVS</strong></td>
<td style="text-align: left;">Enables a simple key-value storage system over flash, suitable for small frequent updates like Bluetooth bonding information.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CONFIG_SETTINGS_NVS</strong></td>
<td style="text-align: left;">Makes the settings subsystem use NVS as the storage backend (instead of, for example, FCB or other flash drivers).</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CONFIG_SETTINGS</strong></td>
<td style="text-align: left;">Provides a general system for saving and loading configuration values. The Bluetooth stack uses it under the hood to store keys and other persistent information.</td>
</tr>
</tbody>
</table>
<p>Then, in your <code>main.c</code> file, you need to include the settings header:</p>
<pre><code class="language-c">#include &lt;zephyr/settings/settings.h&gt;
</code></pre>
<p>and call the following functions in your <code>main()</code> function to initialize the settings subsystem and load the stored settings:</p>
<pre><code class="language-c">bt_enable(NULL);
settings_load();
start_advertising();
</code></pre>
<hr />
<h2 id="whitelisting-aka-filter-accept-list">Whitelisting (a.k.a. Filter Accept List)</h2>
<p>Whitelisting restricts which devices can connect to your Bluetooth advertiser.<br />
It is based on a list of trusted (bonded) devices, called the Filter Accept List (FAL).<br />
When a device is bonded, its address is added to the FAL.<br />
When a device tries to connect, the Bluetooth stack checks if it is in the FAL.</p>
<p>To enable whitelisting, add these configurations in your <code>prj.conf</code>:</p>
<pre><code class="language-kconfig">CONFIG_BT_FILTER_ACCEPT_LIST=y
CONFIG_BT_PRIVACY=y
CONFIG_BT_MAX_PAIRED=3
</code></pre>
<table>
<thead>
<tr>
<th style="text-align: left;">Config</th>
<th style="text-align: left;">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><strong>CONFIG_BT_FILTER_ACCEPT_LIST</strong></td>
<td style="text-align: left;">Enables the use of an internal list of allowed devices for scanning and connection filtering.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CONFIG_BT_PRIVACY</strong></td>
<td style="text-align: left;">Enables the use of Resolvable Private Addresses (RPAs) to protect user identity and avoid static MAC addresses. This helps when using whitelisting, because bonded devices can still recognize each other even if their addresses change.</td>
</tr>
<tr>
<td style="text-align: left;"><strong>CONFIG_BT_MAX_PAIRED</strong></td>
<td style="text-align: left;">Limits how many bonded devices can be stored and managed by the Bluetooth stack.</td>
</tr>
</tbody>
</table>
<h3 id="advertising-with-whitelisting">Advertising with Whitelisting</h3>
<p>To actually use the FAL, you must configure your advertising parameters to filter both:
- <strong>Scan Requests</strong> (devices trying to get more info like UUIDs)
- <strong>Connection Requests</strong> (devices trying to establish a link)</p>
<p>You do this by adding two advertising options:</p>
<ul>
<li><strong>BT_LE_ADV_OPT_FILTER_SCAN_REQ</strong>: only allow devices in the whitelist to send scan requests.</li>
<li><strong>BT_LE_ADV_OPT_FILTER_CONN</strong>: only allow devices in the whitelist to initiate connections.</li>
</ul>
<p>You can define your whitelist-enabled advertising like this:</p>
<pre><code class="language-c">#define BT_LE_ADV_CONN_ACCEPT_LIST \
    BT_LE_ADV_PARAM(BT_LE_ADV_OPT_CONN | BT_LE_ADV_OPT_FILTER_CONN | BT_LE_ADV_OPT_FILTER_SCAN_REQ, \
                    BT_GAP_ADV_FAST_INT_MIN_2, BT_GAP_ADV_FAST_INT_MAX_2, NULL)
</code></pre>
<p>This ensures that only known, bonded devices can see your scan response and initiate a connection.</p>
<h3 id="adding-devices-to-the-whitelist">Adding Devices to the Whitelist</h3>
<p>Before using the Filter Accept List (whitelist) during advertising, you must populate it with the addresses of bonded devices.<br />
This process is typically done after Bluetooth is initialized but before starting advertising.</p>
<pre><code class="language-c">static void add_bonded_device_to_whitelist(const struct bt_bond_info *bond, void *context)
{
    int *added_count = context;

    if (*added_count &lt; 0) {
        return;
    }

    int ret = bt_le_filter_accept_list_add(&amp;bond-&gt;addr);
    if (ret) {
        LOG_INF(&quot;Failed to add device to whitelist (err: %d)&quot;, ret);
        *added_count = -EIO;
    } else {
        (*added_count)++;
        LOG_INF(&quot;Device added to whitelist: %02X %02X&quot;, bond-&gt;addr.a.val[0], bond-&gt;addr.a.val[1]);
    }
}
</code></pre>
<p>We will use this callback function below to add bonded devices to the whitelist:</p>
<pre><code class="language-c">static int configure_whitelist(uint8_t id)
{
    int ret = bt_le_filter_accept_list_clear();
    if (ret) {
        LOG_INF(&quot;Whitelist clear failed (err: %d)&quot;, ret);
        return ret;
    }

    int bonded_devices = 0;
    bt_foreach_bond(id, add_bonded_device_to_whitelist, &amp;bonded_devices);

    return bonded_devices;
}
</code></pre>
<p>This function:
1. Clears any existing whitelist.
2. Iterates over all bonded devices (<code>bt_foreach_bond()</code>).
3. Adds each bonded device to the whitelist.
4. Returns the number of devices added.</p>
<p>Now we just need to call <code>configure_whitelist()</code> before starting advertising:</p>
<hr />
<h2 id="erasing-bonding-information">Erasing Bonding Information</h2>
<p>Sometimes you need to remove all stored bonds, for example when:
- Resetting the device for new users.
- Testing new pairing procedures.</p>
<p>You can erase all bonding information with a simple API call:</p>
<pre><code class="language-c">int ret = bt_unpair(BT_ID_DEFAULT, BT_ADDR_LE_ANY);
</code></pre>
<ul>
<li><code>BT_ID_DEFAULT</code> specifies the local identity (usually 0 unless you use multiple identities).</li>
<li><code>BT_ADDR_LE_ANY</code> means "remove all bonded devices" (wildcard address).</li>
</ul>
<p>If successful, all paired devices are forgotten, and the whitelist (if any) must be rebuilt.</p>
<p>After erasing bonds, you should also clear the FAL to ensure no stale entries remain. Also, you should go to the Bluetooth settings of your central device (e.g., phone) and remove the bond from there as well.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../ble-07-security-modes/" class="btn btn-neutral float-left" title="BLE-Security Modes"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../nfc-01-simple-text/" class="btn btn-neutral float-right" title="NFC-Introduction">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright &copy; 2025 Tony Fu</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/tonyfu97/NrfConnectNotes" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../ble-07-security-modes/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../nfc-01-simple-text/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
